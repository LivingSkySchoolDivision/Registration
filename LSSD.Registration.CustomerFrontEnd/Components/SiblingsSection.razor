@using LSSD.Registration.Model
@using System.Linq;
@using System.Collections.Generic;
@using Blazored.LocalStorage;

@code {
    [Inject]
    LSSD.Registration.CustomerFrontEnd.Services.FormStepTrackerService StepTracker { get; set; }

    [Inject]
    public ILocalStorageService Storage { get; set; }

    [Parameter]
    public string FormName { get; set; }

    [Parameter]
    public int StepNumber { get; set; }

    SiblingInfo Section = new SiblingInfo();

    protected override async Task OnInitializedAsync()
    {
        // Attempt to load a saved section from browser storage.
        // If one doesn't exist, make a new one.
        SiblingInfo LoadedSection = await Storage.GetItemAsync<SiblingInfo>(StorageKeys.Siblings);
        if (LoadedSection != null)
        {
            Section = LoadedSection;
        }
        else
        {
            await Storage.SetItemAsync(StorageKeys.Siblings, Section);
        }
    }

    protected async Task OnClick_PreviousStepButton()
    {
        await saveForm();
        StepTracker.PreviousStep(FormName);
    }

    protected async Task HandleValidSubmit()
    {
        await saveForm();
        StepTracker.NextStep(FormName);
    }

    protected async Task HandleInValidSubmit()
    {
        await saveForm();
    }

    private async Task saveForm()
    {
        await Storage.SetItemAsync(StorageKeys.Siblings, Section);
    }

    private void AddSibling()
    {
        Section.Siblings.Add(new Sibling());
    }

    private void RemoveSibling(Sibling sibling)
    {
        if (Section.Siblings.Contains(sibling))
        {
            Section.Siblings.Remove(sibling);
        }
    }
}

<div class="container">
    <h2>Siblings</h2>
    <EditForm Model="@Section" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <p>Siblings are other school-aged children that live with the student, and are enrolled at a school in Saskatchewan (including schools in other school divisions).</p>
        <p>Do not include graduated students or university students.</p>
        <button type="button" class="btn-sm btn-primary" @onclick="AddSibling">Add Sibling</button>
        <br />
        <br />

        @if (Section.Siblings.Count > 0)
        {
            @foreach (Sibling Sibling in Section.Siblings)
            {
                <div class="form-group container p-2" style="border: 1px solid #dbdbdb; border-radius: 2px;">
                    <div class="form-row">
                        <label class="col-sm-3 font-weight-normal">First Name: </label>
                        <InputText id="" class="form-control col-sm-6 form-control-sm" @bind-Value="@Sibling.FirstName" placeholder="First"></InputText>
                        <ValidationMessage class="offset-sm-4 col-sm-6" For="@(() => Sibling.FirstName)" />
                    </div>
                    <div class="form-row">
                        <label class="col-sm-3 font-weight-normal">Last Name: </label>
                        <InputText id="" class="form-control col-sm-6 form-control-sm" @bind-Value="@Sibling.LastName" placeholder="Last"></InputText>
                        <ValidationMessage class="offset-sm-4 col-sm-6" For="@(() => Sibling.LastName)" />
                    </div>
                    <div class="form-row">
                        <label class="col-sm-3 font-weight-normal">Date of Birth: </label>
                        <InputDate id="" class="form-control col-sm-6 form-control-sm" @bind-Value="@Sibling.DateOfBirth"></InputDate>
                        <ValidationMessage class="offset-sm-4 col-sm-6" For="@(() => Sibling.DateOfBirth)" />
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <label class="col-sm-3 font-weight-normal">School attending: </label>
                            <InputText id="" class="form-control col-sm-6 form-control-sm" @bind-Value="@Sibling.SchoolAttending" placeholder="School Name"></InputText>
                            <ValidationMessage class="offset-sm-4 col-sm-6" For="@(() => Sibling.SchoolAttending)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <button type="button" class="btn-sm btn-link col-sm-1" @onclick="@(() => RemoveSibling(Sibling))">Remove</button>
                    </div>
                </div>
            }

            <button type="button" class="btn-sm btn-primary" @onclick="AddSibling">Add another sibling</button>
        }
        else
        {
            <p><i>No siblings.</i></p>
        }

        <br /><br />
        <div class="form-group">
            <div class="form-row">
                <div class="col">
                    <button type="button" @onclick="OnClick_PreviousStepButton" class="btn btn-secondary btn-block">Previous Step</button>
                </div>
                <div class="col">
                    <button type="submit" class="btn btn-primary btn-block">Next Step</button>
                </div>
            </div>
        </div>
    </EditForm>
</div>